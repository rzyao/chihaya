# 数据流（用户下载、Tracker、PT 网站）

## 参与角色

- 用户客户端（BitTorrent Client）：加载 `.torrent` 或磁力链接，向 Tracker 发起 `announce/scrape`，与 peers 建立连接进行数据传输。
- Tracker 服务器（本项目）：解析请求、生成响应、维护 swarm 状态与 peers 列表，记录指标。
- 存储后端（memory/redis）：保存 IPv4/IPv6 分群的做种/下载者集合与计数，用于响应与垃圾回收。
- PT 网站服务器（私有站常见）：发布 `.torrent`，下发凭据（如 `jwt` 或 passkey），可消费 Tracker 指标或直接访问存储以做运营统计。

## 生命周期分阶段

1. 种子发布与获取
   - PT 网站生成 `.torrent`，内含 Announce URL（HTTP/UDP）。私有站通常在 URL 上携带凭据参数，如 `jwt`（`middleware/jwt/jwt.go:161`）。
   - 客户端下载 `.torrent` 或使用磁力链接，读取 `info_hash` 等元信息（客户端侧行为，非本仓库实现）。

2. 可用性探查（Scrape）
   - 客户端向 Tracker 发起 `scrape` 查询多个 `info_hash` 的群状态：
     - HTTP 路由进入 `scrapeRoute`（`frontend/http/frontend.go:345`），解析 `info_hash` 列表并清洗（`frontend/http/parser.go:124`、`frontend/http/parser.go:140`）。
     - UDP 动作 `action=2`，请求体由多个 20 字节 `info_hash` 组成（`frontend/udp/frontend.go:325`、`frontend/udp/parser.go:201`）。
   - 逻辑层 `HandleScrape` 初始化响应（`middleware/logic.go:79`），`responseHook` 逐个 `ScrapeSwarm` 聚合统计（`middleware/hooks.go:137`、`storage/storage.go:98`）。
   - 返回：
     - HTTP：Bencode `files` 字典，键为原始 20 字节 `info_hash`，值含 `complete/incomplete`（`frontend/http/writer.go:76`）。
     - UDP：序列写入 `complete/snatches/incomplete`（`frontend/udp/writer.go:66`）。

3. 首次加入（Announce started）
   - 客户端以 `event=started` 发起 `announce`：
     - HTTP：路由 `announceRoute`（`frontend/http/frontend.go:304`），`ParseAnnounce` 解析 `info_hash/peer_id/port/uploaded/downloaded/left/numwant/compact/event`，并根据 `AllowIPSpoofing/real_ip_header/RemoteAddr` 选取 IP（`frontend/http/parser.go:31`、`frontend/http/parser.go:147`）。
     - UDP：需先 `connect` 获取连接 ID（`frontend/udp/frontend.go:281`、`frontend/udp/writer.go:76`），再 `announce`，报文固定字段与可选 BEP41 `URLData`（`frontend/udp/parser.go:73`、`frontend/udp/parser.go:157`）。
   - 清洗：`SanitizeAnnounce` 规范 `numwant`、事件等（HTTP `frontend/http/parser.go:116`；UDP `frontend/udp/parser.go:133`）。
   - 逻辑：`HandleAnnounce` 初始化响应并执行 PreHooks（`middleware/logic.go:49`）。
   - 响应生成：`responseHook` 通过 `ScrapeSwarm` 获取计数，`AnnouncePeers` 选取 peers 列表：
     - Seeder 优先返回 Leechers；Leecher 优先返回 Seeders；不足时补同类，并规避自身（`storage/memory/peer_store.go:428`、`storage/redis/peer_store.go:544`）。
   - 写回：
     - HTTP：紧凑/常规 `WriteAnnounceResponse`（`frontend/http/writer.go:30`）。
     - UDP：`WriteAnnounce`（`frontend/udp/writer.go:34`）。
   - 异步状态更新：`AfterAnnounce` 执行 PostHooks → `swarmInteractionHook` 根据事件维护存储（`middleware/logic.go:68`、`middleware/hooks.go:33`）：
     - `Stopped`：`DeleteSeeder` + `DeleteLeecher`（`middleware/hooks.go:39`）。
     - `Completed`：`GraduateLeecher`（`middleware/hooks.go:50`）。
     - `Left==0`：`PutSeeder`；其他：`PutLeecher`（`middleware/hooks.go:57`、`middleware/hooks.go:60`）。

4. 下载过程中的周期性 Announce
   - 客户端周期上报 `uploaded/downloaded/left` 与希望返回的 `numwant`。
   - Tracker 重复上述解析/清洗/响应/异步维护流程，持续更新存储并返回 peers。
   - 中间件可调整行为：
     - 客户端审批/种子审批：拒绝不在白名单的 `ClientID` 或 `InfoHash`（`middleware/clientapproval/clientapproval.go:86`、`middleware/torrentapproval/torrentapproval.go:88`）。
     - JWT 鉴权：校验 `issuer/audience/infohash` 及签名（`middleware/jwt/jwt.go:171`、`middleware/jwt/jwt.go:235`）。
     - 间隔随机化：按概率增大 `interval/min_interval`（`middleware/varinterval/varinterval.go:93`）。

5. 完成与做种（Completed/Seeding）
   - 客户端在完成时发送 `event=completed`，随后通常 `left==0` 持续发 `announce`。
   - 存储层把下载者毕业为做种者或直接记录为做种者（`middleware/hooks.go:50`、`middleware/hooks.go:57`）。

6. 停止（Stopped）
   - 客户端退出或停止下载时发送 `event=stopped`。
   - 存储层删除对应做种/下载者记录（`middleware/hooks.go:39`、`middleware/hooks.go:46`）。

## 核心数据元素

- `info_hash`：20 字节信息哈希（HTTP 解析 `frontend/http/parser.go:57`；UDP 提取 `frontend/udp/parser.go:83`）。
- `peer_id`：20 字节客户端标识（`frontend/http/parser.go:67`、`frontend/udp/parser.go:83`）。
- `port`：客户端监听端口（`frontend/http/parser.go:103`、`frontend/udp/parser.go:109`）。
- `uploaded/downloaded/left`：传输统计（`frontend/http/parser.go:77`、`83`、`89`；UDP `frontend/udp/parser.go:86`、`87`、`88`）。
- `event`：`started/completed/stopped/none`（HTTP `frontend/http/parser.go:41`；UDP `frontend/udp/parser.go:35`）。
- `numwant/compact`：期望 peers 数与紧凑响应模式（`frontend/http/parser.go:95`、`frontend/http/parser.go:52`；UDP `frontend/udp/parser.go:108`、响应为紧凑结构）。
- `ip/ipv4/ipv6` 与 `real_ip_header`：IP 来源（`frontend/http/parser.go:147`、`163`）。

## 安全与 PT 集成

- JWT 流程（私有站常见）：
  - PT 网站作为发行方与受众配置（`issuer/audience`），提供 JWK Set HTTP 端点（`middleware/jwt/jwt.go:64`）。
  - Tracker 后台定期拉取并更新公钥（`middleware/jwt/jwt.go:96`、`middleware/jwt/jwt.go:115`）。
  - 客户端在 `announce` 请求中携带 `jwt` 参数；Tracker 校验标准声明和自定义 `infohash` 声明与签名（`middleware/jwt/jwt.go:171`、`middleware/jwt/jwt.go:235`）。
  - 通过后进入正常业务；失败则返回 `ClientError`（`middleware/jwt/jwt.go:172`、`middleware/jwt/jwt.go:237`）。
- PT 网站侧数据消费（可选）：
  - 指标：Prometheus `/metrics` 暴露 `response_duration`、`infohashes/seeders/leechers`、GC 时长等供站点采集（`pkg/metrics/server.go:39`、`storage/memory/peer_store.go:238`、`storage/redis/peer_store.go:331`）。
  - 存储直连（Redis 模式）：PT 站可在严格权限下只读 `IPv{4,6}_*` 键进行离线统计（结构详见 `storage/redis/peer_store.go:44` 注释与相关键命名函数）。

## 错误与指标流

- 错误返回：统一对客户端以 `bittorrent.ClientError` 表达（HTTP `frontend/http/writer.go:12`；UDP `frontend/udp/writer.go:13`），内部错误消息固定化，避免指标维度爆炸（`frontend/http/prometheus.go:31`、`frontend/udp/prometheus.go:31`）。
- 请求时延：HTTP/UDP 前端记录 `chihaya_{http,udp}_response_duration_milliseconds`（`frontend/http/prometheus.go:16`、`frontend/udp/prometheus.go:16`），标签包含 `action/address_family/error`。
- 存储指标：周期聚合 `infohashes/seeders/leechers` 与 GC 时长（`storage/memory/peer_store.go:238`、`storage/redis/peer_store.go:331`、`storage/memory/peer_store.go:245`、`storage/redis/peer_store.go:809`）。

## HTTP 与 UDP 路径差异

- HTTP：直接路由 `/announce`、`/scrape`，文本 Bencode 响应（`frontend/http/frontend.go:244`、`frontend/http/writer.go:30`、`frontend/http/writer.go:76`）。
- UDP：需 `connect` 获取连接 ID，二进制响应，支持旧式 IPv6 announce（`frontend/udp/frontend.go:281`、`frontend/udp/writer.go:76`、`frontend/udp/parser.go:21`）。

## 入口与停止

- 启动：读取配置，启动指标、存储、逻辑与前端（`cmd/chihaya/main.go:54`、`cmd/chihaya/main.go:80`、`cmd/chihaya/main.go:82`、`cmd/chihaya/main.go:91`）。
- 停止：优雅关闭前端、逻辑与存储（`cmd/chihaya/main.go:113`、`cmd/chihaya/main.go:120`、`cmd/chihaya/main.go:126`）。

