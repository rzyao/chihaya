# 部署文档（Chihaya Tracker）

## 目录约定
- “仓库根目录”指包含 `go.mod` 的项目根，例如 `C:\path\to\chihaya` 或 `/home/user/chihaya`。
- 未特别说明时，所有命令均在“仓库根目录”执行。
- 若明确写出子目录（如 `dist/helm/chihaya`），请先进入该目录再执行相应命令。

## 环境准备
- 操作系统
  - Linux（推荐生产）：Ubuntu/Debian/CentOS
  - Windows（开发/验证）：Windows 10/11 或 Server 2019+
- 运行时
  - Go >= 1.20（构建时）
  - Redis（可选）：用于 passkey 白名单与/或流量推送（Redis Streams）
  - Docker（可选）：容器化部署
  - Kubernetes + Helm（可选）：集群部署
- 网络与端口
  - `http.addr`（默认 `0.0.0.0:6969`）对外开放
  - `udp.addr`（默认 `0.0.0.0:6969`）对外开放
  - 指标 `metrics_addr`（默认 `0.0.0.0:6880`）按需开放（给监控系统）

## 配置准备
- 基础配置文件：`dist/example_config.yaml`
  - 修改 `announce_interval` / `min_announce_interval`、前端监听地址等
  - HTTP 前端 `announce_routes` 可设置为 `"/announce/:passkey"`（命名参数）
- 中间件（已示例启用）：
  - `passkey approval`：Redis 集合校验 + 可选 HTTP 回源
    - `redis_broker`: `redis://pwd@127.0.0.1:6379/0`
    - `set_key`: `pt:passkeys`（成员为合法 passkey）
    - `http_url`: `https://pt.example.com/api/passkey/verify?passkey=`（可选）
  - `traffic push`：将 Announce 的增量事件写入 Redis Streams
    - `stream_key`: `tracker:traffic`
    - `last_key_prefix`: `tracker:last`
    - `retry_count`: `3`、`retry_interval`: `1s`
- Redis（如启用）：
  - 创建 passkey 集合：`SADD pt:passkeys <passkey>`
  - 准备 Streams 消费者组：`XGROUP CREATE tracker:traffic group-pt $`

## 拉取依赖
- 在仓库根目录执行以下命令：
- Windows PowerShell
  - `go env -w GOPROXY=https://goproxy.io,direct`
  - `go mod download`
- Linux/macOS Shell
  - `go env -w GOPROXY=https://goproxy.io,direct`
  - `go mod download`
- 可选替换镜像
  - `go env -w GOPROXY=https://goproxy.cn,direct`

## 构建与打包
- 本地构建（Go）
  - 准备输出目录（在仓库根目录执行）：
    - Windows PowerShell：`mkdir bin` 或 `New-Item -ItemType Directory -Force -Path .\bin`
    - Linux/macOS：`mkdir -p bin`
    - 说明：`go build -o` 不会自动创建目录，`bin` 需预先存在。
  - 在仓库根目录执行：
    - Linux/macOS：`go build -o bin/chihaya ./cmd/chihaya`
    - Windows：`go build -o bin/chihaya.exe ./cmd/chihaya`
- 容器镜像（Docker）
  - 在仓库根目录执行：`docker build -t chihaya:latest .`
  - 运行容器（在任意目录均可执行，但挂载路径需为绝对路径）：
    - `docker run -d --name chihaya -p 6969:6969 -p 6880:6880 -v /path/to/chihaya.yaml:/etc/chihaya.yaml chihaya:latest`
- Helm（Kubernetes）
  - 进入 chart 目录：`dist/helm/chihaya`
  - 在该目录执行安装：`helm install tracker ./chihaya --namespace tracker --create-namespace`
  - 按需通过 `values.yaml` 或 ConfigMap 注入你的 `example_config.yaml` 内容

## 部署与运行
- 直接运行（Windows）
  - 在仓库根目录或二进制所在目录执行：`.\bin\chihaya.exe --config C:\path\to\chihaya.yaml`
- 直接运行（Linux）
  - 在仓库根目录或二进制所在目录执行：`./bin/chihaya --config /etc/chihaya.yaml`
- 进程守护（Linux systemd 示例）
  - 推荐将二进制放置到：`/opt/chihaya/bin/chihaya`
  - `ExecStart=/opt/chihaya/bin/chihaya --config /etc/chihaya.yaml`
  - `Restart=always`，日志与资源限制按需配置
- 验证
  - 指标页：`http://<host>:6880/metrics`
  - HTTP Announce：`http://<host>:6969/announce/<passkey>?info_hash=...&peer_id=...&port=6881&uploaded=0&downloaded=0&left=...&event=started&numwant=50&compact=1`
  - UDP：按照 BEP 15 客户端进行 connect + announce 测试

## 运维要点
- passkey 维护：PT 侧通过 `SADD/SREM pt:passkeys` 管理，定期全量刷新可用“临时集合 + 原子 RENAME”策略
- 流量消费：在 Redis Streams 上用消费者组 `group-pt` 读取，按 `passkey+infohash+peer_id+窗口` 幂等聚合
- 监控：抓取 `/metrics`，关注 HTTP/UDP 响应耗时、infohash/seeders/leechers、GC 时长
- 日志：可选启用 `--debug`、`--json`；Windows 环境建议禁用颜色（默认已处理）

## 常见问题
- 端口冲突：确保 `http.addr/udp.addr/metrics_addr` 未被占用
- Redis 权限：`redis_broker` 需具备 `XADD`、`HMSET/HMGET`、`SISMEMBER/SADD/SREM` 权限
- Announce 解析错误：检查 `info_hash/peer_id` 20 字节长度与百分号编码；端口需非 0
- 构建报错或找不到模块：确认命令在包含 `go.mod` 的“仓库根目录”执行。
- Windows 路径包含空格：为配置路径加引号，如 `--config "C:\\Program Files\\chihaya\\chihaya.yaml"`。
- Linux 安装到系统目录：拷贝到 `/opt/chihaya` 需 `sudo` 权限，注意二进制与配置文件权限。
