# 部署文档（Chihaya Tracker）

## 目录约定
- “仓库根目录”指包含 `go.mod` 的项目根，例如 `C:\path\to\chihaya` 或 `/home/user/chihaya`。
- 未特别说明时，所有命令均在“仓库根目录”执行。
- 若明确写出子目录（如 `dist/helm/chihaya`），请先进入该目录再执行相应命令。

## 环境准备
- 操作系统
  - Linux（推荐生产）：Ubuntu/Debian/CentOS
  - Windows（开发/验证）：Windows 10/11 或 Server 2019+
- 运行时
  - Go >= 1.20（构建时）
  - Redis（可选）：用于 passkey 白名单与/或流量推送（Redis Streams）
  - Docker（可选）：容器化部署
  - Kubernetes + Helm（可选）：集群部署
- 网络与端口
  - `http.addr`（默认 `0.0.0.0:6969`）对外开放
  - `udp.addr`（默认 `0.0.0.0:6969`）对外开放
  - 指标 `metrics_addr`（默认 `0.0.0.0:6880`）按需开放（给监控系统）

## 配置准备
- 基础配置文件：`dist/example_config.yaml`
  - 修改 `announce_interval` / `min_announce_interval`、前端监听地址等
  - HTTP 前端 `announce_routes` 可设置为 `"/announce/:passkey"`（命名参数）
- 中间件（已示例启用）：
  - `passkey approval`：Redis 集合校验 + 可选 HTTP 回源
    - `redis_broker`: `redis://pwd@127.0.0.1:6379/0`
    - `set_key`: `pt:passkeys`（成员为合法 passkey）
    - `http_url`: `https://pt.example.com/api/passkey/verify?passkey=`（可选）
  - `traffic push`：将 Announce 的增量事件写入 Redis Streams
    - `stream_key`: `tracker:traffic`
    - `last_key_prefix`: `tracker:last`
    - `retry_count`: `3`、`retry_interval`: `1s`
- Redis（如启用）：
  - 创建 passkey 集合：`SADD pt:passkeys <passkey>`
  - 准备 Streams 消费者组：`XGROUP CREATE tracker:traffic group-pt $`

## 拉取依赖
- 在仓库根目录执行以下命令：
- Windows PowerShell
  - `go env -w GOPROXY=https://goproxy.io,direct`
  - `go mod tidy`
- Linux/macOS Shell
  - `go env -w GOPROXY=https://goproxy.io,direct`
  - `go mod tidy`
- 可选替换镜像
  - `go env -w GOPROXY=https://goproxy.cn,direct`

## 构建与打包
- 本地构建（Go）
  - 准备输出目录（在仓库根目录执行）：
    - Windows PowerShell：`mkdir bin` 或 `New-Item -ItemType Directory -Force -Path .\bin`
    - Linux/macOS：`mkdir -p bin`
    - 说明：`go build -o` 不会自动创建目录，`bin` 需预先存在。
  - 在仓库根目录执行：
    - Linux/macOS：`go build -o bin/chihaya ./cmd/chihaya`
    - Windows：`go build -o bin/chihaya.exe ./cmd/chihaya`
- 容器镜像（Docker）
  - 在仓库根目录执行：`docker build -t chihaya:latest .`
  - 运行容器（在任意目录均可执行）：
    - 默认配置：`docker run -d --name chihaya -p 6969:6969 -p 6880:6880 -v /usr/local/etc/chihaya:/dist chihaya:latest`
    - 自定义配置（推荐）：挂载目录，首次运行时会自动生成 `config.yaml`
      - `docker run -d --name chihaya -p 6969:6969 -p 6880:6880 -v /usr/local/etc/chihaya:/dist chihaya:latest`
      - 此时宿主机的 `/usr/local/etc/chihaya/config.yaml` 若不存在，会自动从镜像中复制出来。
- Helm（Kubernetes）
  - 进入 chart 目录：`dist/helm/chihaya`
  - 在该目录执行安装：`helm install tracker ./chihaya --namespace tracker --create-namespace`
  - 按需通过 `values.yaml` 或 ConfigMap 注入你的 `example_config.yaml` 内容

## 部署与运行
- 直接运行（Windows）
  - 在仓库根目录或二进制所在目录执行：`.\bin\chihaya.exe --config C:\path\to\chihaya.yaml`
- 直接运行（Linux）
  - 在仓库根目录或二进制所在目录执行：`./bin/chihaya --config /path/to/chihaya.yaml`
  - 如没有 `/etc` 目录或无权限，请使用自定义路径，例如：`$HOME/chihaya.yaml` 或项目内 `./chihaya.yaml`
 - 进程守护（Linux：systemd 服务，生产推荐）
   - 前置准备
     - 推荐二进制路径：`/opt/chihaya/bin/chihaya`；配置：`/etc/chihaya.yaml`
     - 可选创建专用用户：`sudo useradd --system --home /opt/chihaya --shell /usr/sbin/nologin chihaya`
     - 安装文件示例：
       - `sudo install -d -o chihaya -g chihaya /opt/chihaya/bin`
       - `sudo install -m 0755 <构建输出>/chihaya /opt/chihaya/bin/chihaya`
       - `sudo install -m 0644 dist/config.yaml /etc/chihaya.yaml`
   - 创建服务单元：`/etc/systemd/system/chihaya.service`
     - 内容示例（含详细注释，按需调整路径与用户）：
     ```ini
     # [Unit]：服务元信息与依赖
     [Unit]
     Description=Chihaya BitTorrent Tracker
     # 在网络就绪后启动；确保网络在线（可选）
     After=network.target network-online.target
     Wants=network-online.target

     # [Service]：进程与运行时设置
     [Service]
     # 使用简单类型，直接以前台方式运行主进程
     Type=simple
     # 以最小权限运行（建议专用用户），按需修改或移除
     User=chihaya
     Group=chihaya
     # 工作目录（用于相对路径等），可按需调整
     WorkingDirectory=/opt/chihaya
     # 启动命令：指定配置文件路径
     ExecStart=/opt/chihaya/bin/chihaya --config /etc/chihaya.yaml
     # 异常退出时自动重启
     Restart=always
     RestartSec=3s
     # 打开文件数限制（按需调整）
     LimitNOFILE=65535
     # 运行环境变量示例（可按需添加或删除）
     Environment=CHIHAYA_ENV=production

     # [Install]：安装到的目标（用于 enable）
     [Install]
     WantedBy=multi-user.target
     ```
   - 启用与启动
     - 重新加载单元：`sudo systemctl daemon-reload`
     - 开机自启并立即启动：`sudo systemctl enable --now chihaya`
   - 运行验证与运维
     - 查看状态：`systemctl status chihaya`
     - 跟随日志：`journalctl -u chihaya -f`
     - 变更后重启：`sudo systemctl restart chihaya`
     - 覆盖/追加配置：`sudo systemctl edit chihaya`（生成 `/etc/systemd/system/chihaya.service.d/override.conf`）
- 验证
  - 指标页：`http://<host>:6880/metrics`
  - HTTP Announce：`http://<host>:6969/announce/<passkey>?info_hash=...&peer_id=...&port=6881&uploaded=0&downloaded=0&left=...&event=started&numwant=50&compact=1`
  - UDP：按照 BEP 15 客户端进行 connect + announce 测试

## 运维要点
- passkey 维护：PT 侧通过 `SADD/SREM pt:passkeys` 管理，定期全量刷新可用“临时集合 + 原子 RENAME”策略
- 流量消费：在 Redis Streams 上用消费者组 `group-pt` 读取，按 `passkey+infohash+peer_id+窗口` 幂等聚合
- 监控：抓取 `/metrics`，关注 HTTP/UDP 响应耗时、infohash/seeders/leechers、GC 时长
- 日志：可选启用 `--debug`、`--json`；Windows 环境建议禁用颜色（默认已处理）

## 常见问题
- 端口冲突：确保 `http.addr/udp.addr/metrics_addr` 未被占用
- Redis 权限：`redis_broker` 需具备 `XADD`、`HMSET/HMGET`、`SISMEMBER/SADD/SREM` 权限
- Announce 解析错误：检查 `info_hash/peer_id` 20 字节长度与百分号编码；端口需非 0
- 构建报错或找不到模块：确认命令在包含 `go.mod` 的“仓库根目录”执行。
- Windows 路径包含空格：为配置路径加引号，如 `--config "C:\\Program Files\\chihaya\\chihaya.yaml"`。
- Linux 安装到系统目录：拷贝到 `/opt/chihaya` 需 `sudo` 权限，注意二进制与配置文件权限。
