# 项目入门与对接指南（Chihaya Tracker）

## 目录
- 概览
- 能力一览
- 快速开始
- 运行与配置
- 工作流程总览
- 客户端接口
- 对接指南（站点侧）
- 监控与排障
- 安全与最佳实践
- 术语表
- 附录：示例命令

## 概览
- Chihaya 是一个高性能、可插拔的 BitTorrent Tracker，面向 PT 站点与公共 Tracker 使用场景。
- 同时提供 `HTTP(S)` 与 `UDP` 两种前端，支持 IPv4/IPv6，具备可扩展的业务中间件与多种存储后端。
- 内置监控端点与性能分析接口，便于上线、观测与排障。

## 能力一览
- 协议：BEP 3/23（HTTP Announce/Scrape）、BEP 15（UDP）、兼容 BEP 41 可选参数。
- 前端：HTTP 与 UDP 可独立开启；支持紧凑模式与常规 peers 列表返回。
- 中间件：客户端/种子白黑名单、Passkey 审批、JWT 鉴权、间隔随机化、流量事件推送等。
- 存储：内存实现与 Redis 实现；支持定期 GC 与聚合指标。
- 指标与调试：Prometheus `/metrics` 与 pprof `/debug/pprof/*`。

## 快速开始
- 获取：下载官方构建或自行构建可执行文件。
- 最小配置示例（保存为 `dist/config.yaml`）：
```yaml
metrics_addr: 0.0.0.0:6880
http:
  addr: 0.0.0.0:6969
  announce_routes: [/announce]
  scrape_routes: [/scrape]
udp:
  addr: 0.0.0.0:6969
storage:
  name: memory
hooks:
  prehooks: []
  posthooks: []
```
- 启动：`./chihaya -config ./dist/config.yaml`
- 验证：
  - 访问 `http://<host>:6880/metrics` 看到 Prometheus 指标即代表监控服务正常。
  - 执行一次最小 Announce（示例，参数请按实际客户端填写）：
    - `http://<host>:6969/announce?info_hash=<20字节>&peer_id=<20字节>&port=6881&uploaded=0&downloaded=0&left=0`

## 运行与配置
- 指标服务器：
  - `metrics_addr` 用于暴露 `/metrics` 与 `/debug/pprof/*` 端点，建议仅对内网开放或加上反向代理鉴权。
- HTTP 前端：
  - 关键字段：`addr`（监听地址）、`announce_routes`、`scrape_routes`、`allow_ip_spoofing`（是否允许客户端伪装 IP）、`real_ip_header`（在反向代理后读取真实 IP 的头）。
  - `numwant` 限制：可通过默认值与最大值控制返回 peers 的数量，保护服务负载。
- UDP 前端：
  - 关键字段：`addr`（监听地址）、`private_key`（连接 ID 生成密钥）、`max_clock_skew`（时钟偏移容忍）。
- 存储：
  - `name` 选择 `memory` 或 `redis`；`redis` 适合生产环境，`memory` 适合开发与小规模部署。
- 中间件：
  - 通过 `prehooks` 与 `posthooks` 注入业务逻辑，常见如 Passkey 审批、JWT 鉴权与流量事件推送。

## 工作流程总览
- HTTP Announce（典型 6 步）：
  - 接收请求 → 解析查询参数 → 读取来源 IP（或代理头）→ 参数校验与清洗 → 访问存储并准备响应 → 写回客户端并记录时延指标。
- HTTP Scrape（典型 4 步）：
  - 接收请求 → 解析多个 `info_hash` → 聚合各种子状态 → 写回客户端并记录指标。
- UDP 流程要点：
  - 客户端先执行 `connect` 以获取新连接 ID → 使用连接 ID 进行 `announce/scrape` → Tracker 写入响应与 peers。

## 客户端接口
- HTTP Announce 请求参数（查询串）：
  - 必填：`info_hash`（20 字节）、`peer_id`（20 字节）、`port`、`uploaded`、`downloaded`、`left`。
  - 可选：`event`（`started/completed/stopped`）、`numwant`（期望 peers 数量）、`compact`（非空且不为 `0` 时启用紧凑响应）。
  - IP 获取：允许伪装时可携带 `ip/ipv4/ipv6`；在反向代理场景下可通过 `real_ip_header` 获取真实来源。
  - 认证：`passkey`（如站点开启 Passkey 审批，则为必填；以查询参数传递，例如 `?passkey=<passkey>`，由站点侧分发与维护）。
- HTTP Announce 响应：
  - 包含 `interval`、`min interval`、`complete`（做种数）、`incomplete`（下载数）。
  - peers 返回：
    - 紧凑模式：IPv4 用 6 字节序列、IPv6 用 18 字节序列；
    - 常规模式：返回 peer 列表，每个包含 `peer id`、`ip`、`port`。
- HTTP Scrape：
  - 请求可携带多个 `info_hash`；响应返回 `files` 字典，记录各种子的 `complete/incomplete`。
- UDP 接口：
  - `connect/announce/scrape/error` 四种动作；错误字符串以空字符结尾，便于客户端解析。
- 错误格式：
  - 为兼容客户端，失败响应仍使用 200 状态码并返回 bencode `failure reason` 字段，如内部错误时统一为 `internal server error`。

## 对接指南（站点侧）
- Passkey 审批（Redis 集合 + 可选 HTTP 回源）：
  - 目的：仅允许携带有效 passkey 的客户端访问 Tracker。
  - Redis 白名单：在集合中维护有效 `passkey`，Tracker 优先用 `SISMEMBER` 检查；不命中时可回源站点 HTTP 接口确认。
  - 命令格式与返回值：`SISMEMBER <set_key> <passkey>`，返回 `1` 表示成员存在、`0` 表示不存在（当集合键不存在也返回 `0`）。示例：`SISMEMBER pt:passkeys abc123`。批量检查可使用 `SMISMEMBER <set_key> <member...>`（返回 1/0 数组）。
  - 回源约定：请求 `GET <http_url>?passkey=<passkey>`，可携带 `X-API-Key`；返回 `{"valid": true}` 视为通过。`X-API-Key`需要和服务端约定好，否则回源校验会失败。
  - 扩展字段：Passkey JSON 载荷支持 `fd` (影片id) 和 `pd` (片单id) 字段，用于在流量推送中携带优惠信息。
  - TTL 注意：若配置了 `cache_ttl_seconds > 0`，集合会整体过期；需要“持久白名单”请设为 `0` 并由站点维护成员。
  - 运维示例：`SADD pt:passkeys <passkey>`、`SREM pt:passkeys <passkey>`、`SISMEMBER pt:passkeys <passkey>`。
- 流量事件推送（Redis Streams）：
  - 作用：计算每次 Announce 的上传/下载增量并写入流，供结算与风控消费。
  - 字段：`passkey/infohash/peer_id/port/ip/af/du/dd/left/event/ts/dt/interval/min_interval`。
  - 可选字段：`fd` (影片id标识) / `pd` (片单id标识)，仅当 Passkey 载荷中包含这些字段时才会上报。
  - 写入格式：使用 `XADD <stream_key> *` 追加事件，示例：
    - `XADD tracker:traffic * passkey <passkey> infohash <infohash> peer_id <peer_id> port <port> ip <ip> af <4|6> du <du> dd <dd> left <left> event <started|completed|stopped|none> ts <ts> dt <dt> interval <interval> min_interval <min_interval>`
  - 快照键：用于增量计算的上次快照存储在 Hash 键 `tracker:last:<passkey>:<infohash>:<peer_id>`，字段包含 `uploaded/downloaded/port/ip/af/ts`。
  - 类型约定：字段以字符串写入；消费端需将 `du/dd/left/port/af/ts/dt/interval/min_interval` 解析为整数。
  - 保留与清理：默认不会自动删除历史事件，需要站点侧自行修剪以控制体量。
    - 按长度保留最近 N 条：`XTRIM tracker:traffic MAXLEN ~ 1000000`
    - 按时间保留最近 T 天：计算毫秒时间戳 `minid_ms = now_ms - T*24*3600*1000`，然后：`XTRIM tracker:traffic MINID ~ <minid_ms>-0`
    - 建议结合定时任务或消费者组在消费确认后执行修剪；常见保留 7–30 天。
  - 消费建议：使用消费者组，按幂等键（如 `passkey+infohash+peer_id+ts`）处理；失败可按 `retry_count/retry_interval` 简单重试。
- JWT 鉴权（JWK 集）：
  - 用途：为客户端 Announce 提供基于 RS256 的鉴权，校验 `issuer/audience` 与自定义 `infohash` 声明。
  - 要求：`kid` 必须在抓取到的公钥集中可匹配；定期刷新 JWK 集以支持密钥轮换。

### 客户端黑/白名单（Client Approval）
- 作用：限制允许接入的 BT 客户端类型（按 `peer_id` 前 6 字节的 ClientID 识别）。
- 启用方式：在 `chihaya.prehooks` 增加 `client approval` 中间件。
- 配置字段：
  - `whitelist`：允许的 ClientID 列表（每项为 6 字节字符串）
  - `blacklist`：拒绝的 ClientID 列表（每项为 6 字节字符串）
- 匹配规则：客户端的 `peer_id` 前 6 字节与列表项完全匹配即命中；示例 ClientID 如 `-TR3000`（Transmission）、`-UT2210-`（uTorrent）、`qB0000`（qBittorrent，示例）。
- 生效策略：
  - 配置了 `blacklist` 的项将被直接拒绝；
  - 当 `whitelist` 非空时，仅允许命中白名单的客户端；
  - 同时配置时，拒绝优先（先检查黑名单，再按白名单放行）。
- 示例（YAML）：
```yaml
chihaya:
  prehooks:
    - name: "client approval"
      options:
        whitelist:
          - "-TR3000"  # Transmission 示例
          - "-UT2210-" # uTorrent 示例
        blacklist:
          - "OP1012"   # 拒绝的 ClientID 示例
```
- 提示：如需按版本细分，请在 6 字节 ClientID 中包含版本标识（依各客户端约定）。

## 监控与排障
- 监控端点：`/metrics`（Prometheus 拉取）、`/debug/pprof/*`（性能分析）。
- 常见问题：
  - 返回 peers 过少：检查 `numwant` 限制与存储中 peers 数量。
  - IP 异常：确认代理链是否正确设置 `real_ip_header` 或关闭伪装。
  - 认证失败：核对 passkey 是否在白名单、JWT 的签发方与受众是否匹配、公钥是否已刷新。
- 关键指标：
  - 前端响应时延直方图（HTTP/UDP，按 action 与地址族聚合）。
  - 存储层信息哈希与 peers 计数、GC 时长。

## 安全与最佳实践
- 在反向代理后部署，限制对外直接访问；指标与 pprof 建议仅对内开放。
- Redis 开启密码与网络隔离，流消费端使用只读权限。
- JWT 声明绑定 `infohash`，避免令牌泄露后跨种子滥用。
- 对 `numwant` 与 `interval` 做合理限制，避免流量放大。

## 术语表
- Announce：客户端上报自身状态并请求 peers 的过程。
- Scrape：查询种子整体状态（做种/下载数量）。
- Seeder/Leecher：做种者/下载者。
- InfoHash：种子的 20 字节标识。
- Compact：紧凑模式，用字节序列返回 peers。
- Numwant：客户端期望返回的 peers 数量。

## 附录：示例命令
- 创建 passkey 白名单集合：`SADD pt:passkeys <passkey1> <passkey2>`
- 移除失效成员：`SREM pt:passkeys <passkey>`
- 校验某个 passkey：`SISMEMBER pt:passkeys <passkey>`
- 最小 Announce 示例（需替换参数）：
  - `curl "http://<host>:6969/announce?info_hash=<20字节>&peer_id=<20字节>&port=6881&uploaded=0&downloaded=0&left=0&compact=1&passkey=<passkey>"`

## 字段释义（Redis Streams 事件）
- `passkey`：客户端的 passkey（字符串），用于识别用户与做结算/风控。
- `infohash`：种子标识（20 字节的十六进制或原始值表示）。
- `peer_id`：客户端标识（20 字节字符串，一般由客户端生成）。
- `port`：客户端监听端口（整数）。
- `ip`：客户端 IP 地址（字符串，IPv4 或 IPv6）。
- `af`：地址族（整数），`4` 表示 IPv4，`6` 表示 IPv6。
- `du`：本次 Announce 的上传增量（字节数，整数），相对上次快照的变化量。
- `dd`：本次 Announce 的下载增量（字节数，整数），相对上次快照的变化量。
- `left`：剩余未下载的字节数（整数）。
- `event`：Announce 事件类型（字符串），取值 `started/completed/stopped/none`。
- `ts`：当前事件时间戳（秒，整数）。
- `dt`：距离上次快照的秒数（整数）。
- `interval`：建议客户端下次 Announce 的间隔（秒，整数）。
- `min_interval`：建议的最小 Announce 间隔（秒，整数）。
- `fd`：影片id（字符串，可选），透传自 Passkey 载荷。
- `pd`：片单id（字符串，可选），透传自 Passkey 载荷。

## HTTP Scrape 响应格式（Bencode）
- 顶层字典包含键 `files`，其值是一个字典。
- `files` 的键：每个键为种子的 20 字节原始 `info_hash`（原始字节串，不是十六进制字符串）。
- `files` 的值：一个字典，仅包含：
  - `complete`：当前做种者数量（整数）
  - `incomplete`：当前下载者数量（整数）
- 概念示例（为便于阅读，示例中将原始信息哈希用 `<20-byte-infohash>` 表示）：
  - `{ "files": { "<20-byte-infohash-A>": { "complete": 12, "incomplete": 34 }, "<20-byte-infohash-B>": { "complete": 0, "incomplete": 5 } } }`
- 注意：实际线上的 bencode 编码中，`<20-byte-infohash-*>` 是原始 20 字节串，客户端需按 bencode 字符串解析；有些调试工具会将其显示为十六进制以便人类阅读。

## 按 passkey 聚合“做种/下载”的种子集合（推荐做法）
- 场景：站点侧需要按用户（passkey）维度，实时知道该用户正在做种的种子集合与正在下载的种子集合。
- 推荐方案：基于 Redis Streams（`tracker:traffic`）消费增量事件，维护派生集合键。
- 派生键建议：
  - 做种集合：`tracker:passkey:seed:<passkey>`（Set，成员为 `infohash`）
  - 下载集合：`tracker:passkey:leech:<passkey>`（Set，成员为 `infohash`）
  - 做种成员：`tracker:passkey:seed:members:<passkey>:<infohash>`（Set，成员为 `peer_id`）
  - 下载成员：`tracker:passkey:leech:members:<passkey>:<infohash>`（Set，成员为 `peer_id`）
- 消费与维护逻辑：
  - 读取 `tracker:traffic` 的事件；对每条记录：
    - 若 `event=stopped`：从对应的 `members` 集合移除该 `peer_id`，如成员清空则从集合（`seed`/`leech`）移除该 `infohash`。
    - 否则根据 `left` 判断：`left=0` 归入做种集合（并将 `peer_id` 加入做种成员集）；`left>0` 归入下载集合（并将 `peer_id` 加入下载成员集）。
  - 可选清理：按 `ts/dt` 或消费者侧心跳，定期清理长时间未更新的 `peer_id` 成员，避免集合“僵尸状态”。
- 查询示例：
  - 获取某个 passkey 的做种种子集合：`SMEMBERS tracker:passkey:seed:<passkey>`
  - 获取某个 passkey 的下载种子集合：`SMEMBERS tracker:passkey:leech:<passkey>`
  - 统计数量：`SCARD tracker:passkey:seed:<passkey>` / `SCARD tracker:passkey:leech:<passkey>`
  - 查看某个种子的当前做种/下载成员：`SMEMBERS tracker:passkey:seed:members:<passkey>:<infohash>` / `SMEMBERS tracker:passkey:leech:members:<passkey>:<infohash>`
- 设计理由：Tracker 存储按种子维度维护 peers；按用户维度的集合更适合由站点侧消费事件流做派生，便于风控与结算，并避免在 Tracker 内引入复杂查询。
