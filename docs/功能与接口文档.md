# 项目功能与接口文档（Chihaya Tracker）

## 概述

- 多协议 BitTorrent Tracker，支持 `HTTP(S)` 与 `UDP` 前端，同时兼容 IPv4/IPv6。
- 通过中间件实现可插拔的业务逻辑（客户端/种子白黑名单、JWT 鉴权、动态间隔）。
- 存储后端支持 `memory` 与 `redis` 两种实现，内建垃圾回收与 Prometheus 指标。
- 独立指标服务提供 `/metrics` 与 pprof 端点，便于监控与性能分析。

## 架构与入口

- 入口命令与运行流程：`cmd/chihaya/main.go:148`、`cmd/chihaya/main.go:80`。
- 配置解析与组件注册：`cmd/chihaya/config.go:61`、`cmd/chihaya/config.go:10`、`cmd/chihaya/config.go:21`。
- 前端组件：
  - HTTP 前端：路由与启动在 `frontend/http/frontend.go:244`、`frontend/http/frontend.go:147`。
  - UDP 前端：Socket 监听与请求循环在 `frontend/udp/frontend.go:160`、`frontend/udp/frontend.go:169`。
- 跟踪器逻辑与钩子：`middleware/logic.go:29`、`middleware/logic.go:49`、`middleware/hooks.go:33`。
- 存储抽象与实现：接口在 `storage/storage.go:50`，内存实现 `storage/memory/peer_store.go:122`，Redis 实现 `storage/redis/peer_store.go:180`。

## 运行与配置

- 配置文件结构：`cmd/chihaya/config.go:31`；示例见 `dist/example_config.yaml:2`。
- 关键配置项：
  - 指标服务器：`metrics_addr`（`pkg/metrics/server.go:39` 提供 `/metrics` 与 `/debug/pprof/*`）。
  - HTTP 前端：`addr`、`https_addr`、`announce_routes`、`scrape_routes`、`allow_ip_spoofing`、`real_ip_header`、`max_numwant`、`default_numwant`、`max_scrape_infohashes`（`frontend/http/frontend.go:21`）。
  - UDP 前端：`addr`、`private_key`、`max_clock_skew`、`max_numwant`、`default_numwant`、`max_scrape_infohashes`（`frontend/udp/frontend.go:26`）。
  - 存储：`storage.name` 与 `storage.config`（`cmd/chihaya/config.go:25`），内存与 Redis 配置示例见 `dist/example_config.yaml:117` 与 `dist/example_config.yaml:139`。
  - 中间件列表：`prehooks`、`posthooks`（`cmd/chihaya/config.go:37`）。

## HTTP 接口

- 路由
  - Announce：默认 `/announce`，可配置多路由（`frontend/http/frontend.go:244`、`dist/example_config.yaml:54`）。
  - Scrape：默认 `/scrape`，可配置多路由（`frontend/http/frontend.go:249`、`dist/example_config.yaml:64`）。

- Announce 请求参数（查询串，BEP 3/23）：解析逻辑 `frontend/http/parser.go:31`。
  - `info_hash`：必填，20 字节原始值（仅允许单个，`frontend/http/parser.go:57`）。
  - `peer_id`：必填，20 字节（`frontend/http/parser.go:67`）。
  - `port`：必填，客户端监听端口（`frontend/http/parser.go:103`）。
  - `uploaded`、`downloaded`、`left`：必填，均为无符号整数（`frontend/http/parser.go:77`、`frontend/http/parser.go:83`、`frontend/http/parser.go:89`）。
  - `event`：可选，`started`/`completed`/`stopped`（`frontend/http/parser.go:41`、`bittorrent/event.go:...`）。
  - `numwant`：可选，请求返回的 peer 数（`frontend/http/parser.go:95`）。
  - `compact`：可选，非空且不为 `0` 时启用紧凑响应（`frontend/http/parser.go:52`）。
  - IP 相关：在允许伪装时支持 `ip`/`ipv4`/`ipv6`（`frontend/http/parser.go:147`）。此外可通过反向代理头 `real_ip_header` 取源 IP（`frontend/http/parser.go:163`）。
  - JWT：如启用 JWT 中间件，需携带 `jwt` 参数（`middleware/jwt/jwt.go:161`）。

- Announce 响应（Bencode，`frontend/http/writer.go:30`）：
  - 字段：`interval`、`min interval`、`complete`（做种数）、`incomplete`（下载数）。
  - Peers：
    - 紧凑模式：`peers`（IPv4，6 字节序列）与 `peers6`（IPv6，18 字节序列）（`frontend/http/writer.go:38`）。
    - 常规模式：`peers` 为列表，元素包含 `peer id`、`ip`、`port`（`frontend/http/writer.go:61`）。

- Scrape 请求与响应：
  - 请求：多 `info_hash`（`frontend/http/parser.go:130`）。
  - 响应：`files` 字典，键为 20 字节原始 info_hash，值含 `complete`、`incomplete`（`frontend/http/writer.go:76`）。

- 错误返回：始终 200，Bencode `{"failure reason": <message>}`（`frontend/http/writer.go:12`）。当为内部错误时 message 固定为 `internal server error`。

## UDP 接口

- Action 定义（BEP 15）：`connect=0`、`announce=1`、`scrape=2`、`error=3`，以及兼容旧 IPv6 announce `4`（`frontend/udp/parser.go:13`）。

- Connect 流程：
  - 请求校验初始连接 ID 魔数（`frontend/udp/frontend.go:283`）。
  - 响应下发新连接 ID（HMAC 生成，`frontend/udp/frontend.go:298`）。

- Announce 请求结构（`frontend/udp/parser.go:83`）：
  - `info_hash[16:36]`、`peer_id[36:56]`、`downloaded[56:64]`、`left[64:72]`、`uploaded[72:80]`。
  - `event` 位于索引 `83`，映射至 `None/Completed/Started/Stopped`（`frontend/udp/parser.go:35`）。
  - IP：当允许伪装时取报文中 `84:...` 字段，否则取报文源地址（`frontend/udp/parser.go:97`、`frontend/udp/parser.go:102`）。
  - `numwant`、`port` 紧随 IP 区间之后（`frontend/udp/parser.go:107`、`frontend/udp/parser.go:108`）。
  - 可选参数：支持 BEP 41 `URLData`（`frontend/udp/parser.go:157`、`frontend/udp/parser.go:175`）。

- Announce 响应（`frontend/udp/writer.go:29`）：
  - 按秒单位写入 `interval`、`incomplete`、`complete`，后接若干 peer 的 `IP + port`（对应 IPv4/IPv6 选取）。

- Scrape 请求与响应：
  - 请求：`[16:]` 切分为多个 20 字节 info_hash（`frontend/udp/parser.go:208`）。
  - 响应：按序写入 `complete`、`snatches`、`incomplete`（`frontend/udp/writer.go:66`）。

- 错误响应：`errorActionID=3`，字符串以 `\0` 结尾（`frontend/udp/writer.go:13`）。

## 中间件（Hooks）

- 统一接口：`middleware/hooks.go:13`，支持 PreHooks 与 PostHooks。
- 核心响应/交互钩子：
  - `responseHook`：附加 `complete/incomplete` 与 peers（`middleware/hooks.go:93`）。
  - `swarmInteractionHook`：依据事件维护种子/下载者（`middleware/hooks.go:33`）。
- 可选业务钩子：
  - 客户端审批：白/黑名单匹配 `ClientID`（`middleware/clientapproval/clientapproval.go:86`），配置项 `whitelist/blacklist`。
  - 种子审批：白/黑名单匹配 `infohash`（`middleware/torrentapproval/torrentapproval.go:88`），配置项 `whitelist/blacklist`。
  - JWT 鉴权：参数 `jwt`，校验标准声明与自定义 `infohash`，JWK 周期更新（`middleware/jwt/jwt.go:61`、`middleware/jwt/jwt.go:161`）。
  - 间隔随机化：按概率增大 `interval/min_interval`（`middleware/varinterval/varinterval.go:93`）。

## 存储层

- 抽象接口：`storage/storage.go:50`，要求 IPv4/IPv6 群隔离、GC 与指标聚合。
- 内存实现：分片分组，定期 GC，指标聚合（`storage/memory/peer_store.go:122`、`storage/memory/peer_store.go:513`）。
- Redis 实现：哈希结构、计数器、事务保证、定期 GC（`storage/redis/peer_store.go:264`、`storage/redis/peer_store.go:709`）。
- Scrape 与 Announce 规则：优先返回对端所需的 peers，seed/leecher 选取规则见 `storage/*/peer_store.go:428` 与 `storage/*/peer_store.go:544`。

## 指标与监控

- 指标端点：`/metrics`（Prometheus），`/debug/pprof/*`（pprof）（`pkg/metrics/server.go:39`）。
- 前端时延直方图：HTTP/UDP 分别记录 `action`、`address_family`、`error`（`frontend/http/prometheus.go:...`、`frontend/udp/prometheus.go:...`）。
- 存储层聚合指标：`infohashes`、`seeders`、`leechers` 计数与 GC 时长（`storage/memory/peer_store.go:238`、`storage/redis/peer_store.go:331`、`storage/memory/peer_store.go:245`）。

## 错误处理与校验

- 所有对客户端可见的错误以 `bittorrent.ClientError` 形式返回（`frontend/http/writer.go:12`、`frontend/udp/writer.go:16`）。
- 请求参数解析与最小化清洗：`bittorrent/params.go:107`、`bittorrent/sanitize.go:...`；HTTP/UDP 均调用 `SanitizeAnnounce/SanitizeScrape`（`frontend/http/parser.go:116`、`frontend/http/parser.go:140`、`frontend/udp/parser.go:133`、`frontend/udp/parser.go:224`）。

## 重要代码参考

- 入口与命令：`cmd/chihaya/main.go:148`、`cmd/chihaya/main.go:221`。
- HTTP 路由与处理：`frontend/http/frontend.go:244`、`frontend/http/frontend.go:303`、`frontend/http/writer.go:30`。
- UDP 处理循环：`frontend/udp/frontend.go:169`、`frontend/udp/frontend.go:253`、`frontend/udp/writer.go:60`。
- 业务逻辑与钩子：`middleware/logic.go:49`、`middleware/hooks.go:33`、`middleware/hooks.go:93`。
- 存储接口与实现：`storage/storage.go:50`、`storage/memory/peer_store.go:122`、`storage/redis/peer_store.go:180`。

## 数据流

- HTTP Announce
  - 接收请求：路由到 `announceRoute`（`frontend/http/frontend.go:304`），可选计时（`frontend/http/frontend.go:307`）。
  - 解析参数：`ParseAnnounce` 读取 `RequestURI` 并构造 `AnnounceRequest`（`frontend/http/parser.go:31`）。
  - 获取 IP：`requestedIP` 根据伪装、头 `real_ip_header` 或 `RemoteAddr` 选择（`frontend/http/parser.go:147`）。
  - 清洗校验：`SanitizeAnnounce`（`frontend/http/parser.go:116`）。
  - 业务响应：`logic.HandleAnnounce` 初始化响应并执行 PreHooks（`middleware/logic.go:49`）；`responseHook` 读取存储并填充计数与 peers（`middleware/hooks.go:93`、`middleware/hooks.go:107`）。
  - 写回客户端：`WriteAnnounceResponse`（`frontend/http/writer.go:30`）。
  - 异步交互：`logic.AfterAnnounce` 执行 PostHooks（`middleware/logic.go:68`）；`swarmInteractionHook` 依据事件维护存储（`middleware/hooks.go:33`）。
  - 指标记录：`recordResponseDuration`（`frontend/http/prometheus.go:16`）。

- HTTP Scrape
  - 接收请求：`scrapeRoute`（`frontend/http/frontend.go:345`）。
  - 解析与清洗：`ParseScrape` + `SanitizeScrape`（`frontend/http/parser.go:124`、`frontend/http/parser.go:140`）。
  - 业务响应：`logic.HandleScrape` + `responseHook` 聚合 `files`（`middleware/logic.go:79`、`middleware/hooks.go:137`）。
  - 写回客户端：`WriteScrapeResponse`（`frontend/http/writer.go:76`）。
  - 异步交互与指标：`logic.AfterScrape`（`middleware/logic.go:95`）、`recordResponseDuration`（`frontend/http/frontend.go:353`）。

- UDP Connect
  - 读取包：循环从 UDP socket 取包（`frontend/udp/frontend.go:186`）。
  - 解析头：校验初始连接 ID 魔数与 action（`frontend/udp/frontend.go:281`）。
  - 生成连接 ID：HMAC `ConnectionIDGenerator`（`frontend/udp/frontend.go:298`）。
  - 写回客户端与指标：`WriteConnectionID`（`frontend/udp/writer.go:76`）、`recordResponseDuration`（`frontend/udp/prometheus.go:16`）。

- UDP Announce
  - 解析：`ParseAnnounce` 抽取固定字段与可选 BEP41 `URLData`（`frontend/udp/parser.go:73`、`frontend/udp/parser.go:157`）。
  - 清洗：`SanitizeAnnounce`（`frontend/udp/parser.go:133`）。
  - 业务响应：`logic.HandleAnnounce` + `responseHook`（`frontend/udp/frontend.go:314`、`middleware/hooks.go:93`）。
  - 写回客户端：`WriteAnnounce`（`frontend/udp/writer.go:34`）。
  - 异步交互与指标：`logic.AfterAnnounce`（`frontend/udp/frontend.go:321`）、`recordResponseDuration`（`frontend/udp/prometheus.go:16`）。

- UDP Scrape
  - 解析与清洗：`ParseScrape` + `SanitizeScrape`（`frontend/udp/parser.go:201`、`frontend/udp/parser.go:224`）。
  - 业务响应与写回：`logic.HandleScrape`（`frontend/udp/frontend.go:347`）、`WriteScrape`（`frontend/udp/writer.go:61`）。
  - 异步交互与指标：`logic.AfterScrape`（`frontend/udp/frontend.go:355`）、`recordResponseDuration`（`frontend/udp/prometheus.go:16`）。

- 存储交互（事件驱动）
  - Stopped：`DeleteSeeder` + `DeleteLeecher`（`middleware/hooks.go:39`）。
  - Completed：`GraduateLeecher`（`middleware/hooks.go:50`）。
  - Left==0：`PutSeeder`（`middleware/hooks.go:57`）。
  - 其他：`PutLeecher`（`middleware/hooks.go:60`）。
  - AnnouncePeers：选取规则（`storage/memory/peer_store.go:428`、`storage/redis/peer_store.go:544`）。

- 错误与回写
  - HTTP：`WriteError` 返回 200 + Bencode（`frontend/http/writer.go:12`）。
  - UDP：`WriteError` action=3，字符串以 `\0` 结尾（`frontend/udp/writer.go:13`）。

- 指标上报
  - HTTP/UDP：`chihaya_{http,udp}_response_duration_milliseconds` 直方图（`frontend/http/prometheus.go:16`、`frontend/udp/prometheus.go:16`）。
  - 存储：信息哈希与 Peer 计数、GC 时长（`storage/memory/peer_store.go:238`、`storage/redis/peer_store.go:331`、`storage/memory/peer_store.go:245`）。

