# 改写目标
- 删除文档中所有“代码位置/行号/文件路径”的技术细节引用，改为通俗的流程与模块说明。
- 让未接触过本项目的人能快速理解：项目做什么、如何运行、如何与站点/客户端对接、如何排障与监控。

## 改动范围
- 仅重写 `docs/功能与接口文档.md`（不改动源码）。
- 保留现有技术点，但用人话解释，配最小必要示例（YAML、curl、Redis 命令）。

## 新文档结构
1. 项目概览（是什么、能做什么）
2. 快速开始（下载/构建→最小配置→启动→健康检查）
3. 工作流程总览（客户端 Announce/Scrape → 前端解析 → 校验与钩子 → 存储 → 回写 → 指标）
4. 配置详解（核心字段与默认值：`metrics_addr`、`http/udp`、`storage`、`hooks`）
5. 对接指南（站点/业务侧）：
   - Passkey 审批（Redis 集合 + 可选 HTTP 回源）：目的、如何配置、请求约定、TTL 注意事项
   - 流量事件推送（Redis Streams）：字段含义、消费建议、重试策略
   - JWT 鉴权（JWK 集）：用途、令牌要求、配置项
6. 客户端接口说明（面向 BT 客户端）：
   - HTTP：参数解释、响应字段、紧凑模式、失败返回
   - UDP：动作与请求/响应结构、错误响应
   - 示例：可复制的 `curl` 请求与示例响应
7. 监控与排障（Prometheus/pprof 端点、常见错误、关键指标）
8. 安全与最佳实践（真实 IP、JWT 安全、Redis 权限、API Key）
9. 术语表（Announce/Scrape/Seeder/Leecher/InfoHash/Compact/Numwant 等）
10. 版本兼容性与注意事项（如端口、IPv4/IPv6、BEP 规范对齐）

## 文风与呈现
- 先讲为什么，再讲怎么做；用列表与步骤词解释，不引用源码位置。
- 每节落地到“你需要做什么”，并给出最少可运行示例。
- 若涉及术语，旁边立即给短解释；复杂流程用 3～5 步串起来。

## 示例片段（预览）
### 快速开始（示例配置）
```yaml
metrics_addr: 0.0.0.0:6880
http:
  addr: 0.0.0.0:6969
  announce_routes: [/announce]
  scrape_routes: [/scrape]
udp:
  addr: 0.0.0.0:6969
storage:
  name: memory
hooks:
  prehooks: []
  posthooks: []
```
- 启动：`./chihaya -config ./dist/config.yaml`
- 健康检查：浏览器访问 `http://<host>:6880/metrics` 或 `http://<host>:6969/announce?info_hash=...&peer_id=...&port=6881&uploaded=0&downloaded=0&left=0`（用于验证接口连通）。

### 对接：Passkey 审批（站点侧三步）
1. 在 Redis 建白名单集合：`SADD pt:passkeys <passkey>`。
2. Tracker 配置指向该集合并开启审批（可选回源 HTTP 校验）。
3. 客户端在 Announce URL 中携带 `passkey`（通常由站点下发），不通过的请求会被拒绝并返回失败原因。

### 客户端 Announce（HTTP）要点
- 必填参数：`info_hash`、`peer_id`、`port`、`uploaded`、`downloaded`、`left`。
- 可选：`event`（`started/completed/stopped`）、`numwant`（期望返回 peer 数量）、`compact`（紧凑模式）。
- 响应含：`interval`、`min interval`、`complete（做种数）`、`incomplete（下载数）`，以及 peers 列表或紧凑字节序列。
- 错误始终以 200 返回，包含 `failure reason`（便于客户端兼容）。

## 实施步骤
1. 备份现有文档。
2. 按新结构重写各章节，移除所有源码位置与行号引用。
3. 添加最小配置、示例请求与 Redis 命令，保证可复制运行。
4. 审校术语与参数解释，确保非专业读者能理解。
5. 自测：使用本地最小配置 + `curl` 调用，确认示例有效。
6. 交付新版文档，保留清晰目录便于检索。

## 验收标准
- 文档不出现任何“文件路径/行号”提示。
- 新手可依据文档完成：启动→简单请求→站点对接（任选 Passkey/JWT/Streams）。
- 具备排障与监控指引；示例均可直接复制执行。